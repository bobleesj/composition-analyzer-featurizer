from deepdiff import DeepDiff

from CAF.features.universal import generate_features


def test_generate_features_ternary(oliynyk_db):
    formula = "Al3Be2Cl5"
    actual_features = generate_features(formula, oliynyk_db)
    expected_features = {
        "formula": "Al3Be2Cl5",
        "index_norm_first_element": 0.3,
        "index_norm_last_element": 0.5,
        "index_norm_max": 0.5,
        "index_norm_min": 0.2,
        "num_element": 3,
        "unpaired_electrons_avg_weighted_norm": 0.8,
        "unpaired_electrons_avg": 0.666666667,
        "unpaired_electrons_max": 1,
        "unpaired_electrons_min": 0,
        "unpaired_electrons_first_element": 1,
        "unpaired_electrons_last_element": 1,
        "atomic_weight_avg_weighted_norm": 27.6232477,
        "atomic_weight_avg": 23.815473,
        "atomic_weight_max": 35.4527,
        "atomic_weight_min": 9.01218,
        "atomic_weight_max_by_min": 3.933865058,
        "atomic_weight_first_element": 26.981539,
        "atomic_weight_last_element": 35.4527,
        "atomic_number_avg_weighted_norm": 13.2,
        "atomic_number_avg": 11.33333333,
        "atomic_number_max": 17,
        "atomic_number_min": 4,
        "atomic_number_max_by_min": 4.25,
        "atomic_number_first_element": 13,
        "atomic_number_last_element": 17,
        "period_avg_weighted_norm": 2.8,
        "period_avg": 2.666666667,
        "period_max": 3,
        "period_min": 2,
        "period_max_by_min": 1.5,
        "period_first_element": 3,
        "period_last_element": 3,
        "group_avg_weighted_norm": 12.8,
        "group_avg": 10.66666667,
        "group_max": 17,
        "group_min": 2,
        "group_max_by_min": 8.5,
        "group_first_element": 13,
        "group_last_element": 17,
        "Mendeleev_number_avg_weighted_norm": 82.3,
        "Mendeleev_number_avg": 78.0,
        "Mendeleev_number_max": 94,
        "Mendeleev_number_min": 67,
        "Mendeleev_number_max_by_min": 1.402985075,
        "Mendeleev_number_first_element": 73,
        "Mendeleev_number_last_element": 94,
        "valencee_total_avg_weighted_norm": 4.8,
        "valencee_total_avg": 4.0,
        "valencee_total_max": 7,
        "valencee_total_min": 2,
        "valencee_total_max_by_min": 3.5,
        "valencee_total_first_element": 3,
        "valencee_total_last_element": 7,
        "Gilman_avg_weighted_norm": 4.8,
        "Gilman_avg": 4.0,
        "Gilman_max": 7,
        "Gilman_min": 2,
        "Gilman_max_by_min": 3.5,
        "Gilman_first_element": 3,
        "Gilman_last_element": 7,
        "Z_eff_avg_weighted_norm": 2.3919,
        "Z_eff_avg": 2.191,
        "Z_eff_max": 2.928,
        "Z_eff_min": 1.656,
        "Z_eff_max_by_min": 1.768115942,
        "Z_eff_first_element": 1.989,
        "Z_eff_last_element": 2.928,
        "ionization_energy_avg_weighted_norm": 10.14408,
        "ionization_energy_avg": 9.425366667,
        "ionization_energy_max": 12.9676,
        "ionization_energy_min": 5.9858,
        "ionization_energy_max_by_min": 2.166393799,
        "ionization_energy_first_element": 5.9858,
        "ionization_energy_last_element": 12.9676,
        "coordination_number_avg_weighted_norm": 6.5,
        "coordination_number_avg": 8.333333333,
        "coordination_number_max": 12,
        "coordination_number_min": 1,
        "coordination_number_max_by_min": 12.0,
        "coordination_number_first_element": 12,
        "coordination_number_last_element": 1,
        "ratio_closest_avg_weighted_norm": 0.497,
        "ratio_closest_avg": 0.564666667,
        "ratio_closest_max": 1.0,
        "ratio_closest_min": 0.194,
        "ratio_closest_max_by_min": 5.154639175,
        "ratio_closest_first_element": 1.0,
        "ratio_closest_last_element": 0.194,
        "polyhedron_distortion_avg_weighted_norm": 0.9948,
        "polyhedron_distortion_avg": 0.991333333,
        "polyhedron_distortion_max": 1.0,
        "polyhedron_distortion_min": 0.974,
        "polyhedron_distortion_max_by_min": 1.026694045,
        "polyhedron_distortion_first_element": 1.0,
        "polyhedron_distortion_last_element": 1.0,
        "CIF_radius_avg_weighted_norm": 1.0914,
        "CIF_radius_avg": 1.116666667,
        "CIF_radius_max": 1.31,
        "CIF_radius_min": 0.968,
        "CIF_radius_max_by_min": 1.353305785,
        "CIF_radius_first_element": 1.31,
        "CIF_radius_last_element": 0.968,
        "Pauling_radius_CN12_avg_weighted_norm": 1.3773,
        "Pauling_radius_CN12_avg": 1.333333333,
        "Pauling_radius_CN12_max": 1.448,
        "Pauling_radius_CN12_min": 1.123,
        "Pauling_radius_CN12_max_by_min": 1.289403384,
        "Pauling_radius_CN12_first_element": 1.429,
        "Pauling_radius_CN12_last_element": 1.448,
        "Pauling_EN_avg_weighted_norm": 2.377,
        "Pauling_EN_avg": 2.113333333,
        "Pauling_EN_max": 3.16,
        "Pauling_EN_min": 1.57,
        "Pauling_EN_max_by_min": 2.012738854,
        "Pauling_EN_first_element": 1.61,
        "Pauling_EN_last_element": 3.16,
        "Martynov_Batsanov_EN_avg_weighted_norm": 2.272,
        "Martynov_Batsanov_EN_avg": 2.023333333,
        "Martynov_Batsanov_EN_max": 2.98,
        "Martynov_Batsanov_EN_min": 1.45,
        "Martynov_Batsanov_EN_max_by_min": 2.055172414,
        "Martynov_Batsanov_EN_first_element": 1.64,
        "Martynov_Batsanov_EN_last_element": 2.98,
        "melting_point_K_avg_weighted_norm": 676.25,
        "melting_point_K_avg": 885.4833333,
        "melting_point_K_max": 1551.15,
        "melting_point_K_min": 172.15,
        "melting_point_K_max_by_min": 9.010455998,
        "melting_point_K_first_element": 933.15,
        "melting_point_K_last_element": 172.15,
        "density_avg_weighted_norm": 1.181605,
        "density_avg": 1.517736667,
        "density_max": 2.7,
        "density_min": 0.00321,
        "density_max_by_min": 841.1214953,
        "density_first_element": 2.7,
        "density_last_element": 0.00321,
        "specific_heat_avg_weighted_norm": 0.874,
        "specific_heat_avg": 1.066666667,
        "specific_heat_max": 1.82,
        "specific_heat_min": 0.48,
        "specific_heat_max_by_min": 3.791666667,
        "specific_heat_first_element": 0.9,
        "specific_heat_last_element": 0.48,
        "cohesive_energy_avg_weighted_norm": 2.381,
        "cohesive_energy_avg": 2.703333333,
        "cohesive_energy_max": 3.39,
        "cohesive_energy_min": 1.4,
        "cohesive_energy_max_by_min": 2.421428571,
        "cohesive_energy_first_element": 3.39,
        "cohesive_energy_last_element": 1.4,
        "bulk_modulus_avg_weighted_norm": 45.11,
        "bulk_modulus_avg": 62.1,
        "bulk_modulus_max": 110.0,
        "bulk_modulus_min": 1.1,
        "bulk_modulus_max_by_min": 99.999999,
        "bulk_modulus_first_element": 75.2,
        "bulk_modulus_last_element": 1.1,
    }

    diff = DeepDiff(expected_features, actual_features, significant_digits=3)
    assert diff == {}


def test_generate_features_binary(oliynyk_db):
    formula = "NdSi2"
    actual_features = generate_features(formula, oliynyk_db)
    expected_features = {
        "formula": "NdSi2",
        "index_norm_first_element": 0.333333,
        "index_norm_last_element": 0.666667,
        "index_norm_max": 0.666667,
        "index_norm_min": 0.333333,
        "num_element": 2,
        "unpaired_electrons_avg_weighted_norm": 2.666666,
        "unpaired_electrons_avg": 3.0,
        "unpaired_electrons_max": 4,
        "unpaired_electrons_min": 2,
        "unpaired_electrons_first_element": 4,
        "unpaired_electrons_last_element": 2,
        "atomic_weight_avg_weighted_norm": 66.8042946145,
        "atomic_weight_avg": 86.16375,
        "atomic_weight_max": 144.242,
        "atomic_weight_min": 28.0855,
        "atomic_weight_max_by_min": 5.135817414680173,
        "atomic_weight_first_element": 144.242,
        "atomic_weight_last_element": 28.0855,
        "atomic_number_avg_weighted_norm": 29.333318,
        "atomic_number_avg": 37.0,
        "atomic_number_max": 60,
        "atomic_number_min": 14,
        "atomic_number_max_by_min": 4.285714285714286,
        "atomic_number_first_element": 60,
        "atomic_number_last_element": 14,
        "period_avg_weighted_norm": 3.999999,
        "period_avg": 4.5,
        "period_max": 6,
        "period_min": 3,
        "period_max_by_min": 2.0,
        "period_first_element": 6,
        "period_last_element": 3,
        "group_avg_weighted_norm": 10.333337,
        "group_avg": 8.5,
        "group_max": 14,
        "group_min": 3,
        "group_max_by_min": 4.666666666666667,
        "group_first_element": 3,
        "group_last_element": 14,
        "Mendeleev_number_avg_weighted_norm": 58.333352999999995,
        "Mendeleev_number_avg": 48.5,
        "Mendeleev_number_max": 78,
        "Mendeleev_number_min": 19,
        "Mendeleev_number_max_by_min": 4.105263157894737,
        "Mendeleev_number_first_element": 19,
        "Mendeleev_number_last_element": 78,
        "valencee_total_avg_weighted_norm": 4.666666,
        "valencee_total_avg": 5.0,
        "valencee_total_max": 6,
        "valencee_total_min": 4,
        "valencee_total_max_by_min": 1.5,
        "valencee_total_first_element": 6,
        "valencee_total_last_element": 4,
        "Gilman_avg_weighted_norm": 3.666667,
        "Gilman_avg": 3.5,
        "Gilman_max": 4,
        "Gilman_min": 3,
        "Gilman_max_by_min": 1.3333333333333333,
        "Gilman_first_element": 3,
        "Gilman_last_element": 4,
        "Z_eff_avg_weighted_norm": 2.8213328330000005,
        "Z_eff_avg": 3.0715000000000003,
        "Z_eff_max": 3.822,
        "Z_eff_min": 2.321,
        "Z_eff_max_by_min": 1.6467040068935803,
        "Z_eff_first_element": 3.822,
        "Z_eff_last_element": 2.321,
        "ionization_energy_avg_weighted_norm": 7.2761342089,
        "ionization_energy_avg": 6.83835,
        "ionization_energy_max": 8.1517,
        "ionization_energy_min": 5.525,
        "ionization_energy_max_by_min": 1.475420814479638,
        "ionization_energy_first_element": 5.525,
        "ionization_energy_last_element": 8.1517,
        "coordination_number_avg_weighted_norm": 6.666664,
        "coordination_number_avg": 8.0,
        "coordination_number_max": 12,
        "coordination_number_min": 4,
        "coordination_number_max_by_min": 3.0,
        "coordination_number_first_element": 12,
        "coordination_number_last_element": 4,
        "ratio_closest_avg_weighted_norm": 0.8333335,
        "ratio_closest_avg": 0.75,
        "ratio_closest_max": 1.0,
        "ratio_closest_min": 0.5,
        "ratio_closest_max_by_min": 2.0,
        "ratio_closest_first_element": 0.5,
        "ratio_closest_last_element": 1.0,
        "polyhedron_distortion_avg_weighted_norm": 0.9973333360000001,
        "polyhedron_distortion_avg": 0.996,
        "polyhedron_distortion_max": 1.0,
        "polyhedron_distortion_min": 0.992,
        "polyhedron_distortion_max_by_min": 1.0080645161290323,
        "polyhedron_distortion_first_element": 0.992,
        "polyhedron_distortion_last_element": 1.0,
        "CIF_radius_avg_weighted_norm": 1.388333121,
        "CIF_radius_avg": 1.4945,
        "CIF_radius_max": 1.813,
        "CIF_radius_min": 1.176,
        "CIF_radius_max_by_min": 1.5416666666666667,
        "CIF_radius_first_element": 1.813,
        "CIF_radius_last_element": 1.176,
        "Pauling_radius_CN12_avg_weighted_norm": 1.483333166,
        "Pauling_radius_CN12_avg": 1.5670000000000002,
        "Pauling_radius_CN12_max": 1.818,
        "Pauling_radius_CN12_min": 1.316,
        "Pauling_radius_CN12_max_by_min": 1.3814589665653496,
        "Pauling_radius_CN12_first_element": 1.818,
        "Pauling_radius_CN12_last_element": 1.316,
        "Pauling_EN_avg_weighted_norm": 1.64666692,
        "Pauling_EN_avg": 1.52,
        "Pauling_EN_max": 1.9,
        "Pauling_EN_min": 1.14,
        "Pauling_EN_max_by_min": 1.6666666666666667,
        "Pauling_EN_first_element": 1.14,
        "Pauling_EN_last_element": 1.9,
        "Martynov_Batsanov_EN_avg_weighted_norm": 1.72000026,
        "Martynov_Batsanov_EN_avg": 1.5899999999999999,
        "Martynov_Batsanov_EN_max": 1.98,
        "Martynov_Batsanov_EN_min": 1.2,
        "Martynov_Batsanov_EN_max_by_min": 1.6500000000000001,
        "Martynov_Batsanov_EN_first_element": 1.2,
        "Martynov_Batsanov_EN_last_element": 1.98,
        "melting_point_K_avg_weighted_norm": 1551.816798,
        "melting_point_K_avg": 1486.15,
        "melting_point_K_max": 1683.15,
        "melting_point_K_min": 1289.15,
        "melting_point_K_max_by_min": 1.3056277392080053,
        "melting_point_K_first_element": 1289.15,
        "melting_point_K_last_element": 1683.15,
        "density_avg_weighted_norm": 3.88666511,
        "density_avg": 4.665,
        "density_max": 7.0,
        "density_min": 2.33,
        "density_max_by_min": 3.004291845493562,
        "density_first_element": 7.0,
        "density_last_element": 2.33,
        "specific_heat_avg_weighted_norm": 0.53666684,
        "specific_heat_avg": 0.44999999999999996,
        "specific_heat_max": 0.71,
        "specific_heat_min": 0.19,
        "specific_heat_max_by_min": 3.7368421052631575,
        "specific_heat_first_element": 0.19,
        "specific_heat_last_element": 0.71,
        "cohesive_energy_avg_weighted_norm": 4.22000041,
        "cohesive_energy_avg": 4.015,
        "cohesive_energy_max": 4.63,
        "cohesive_energy_min": 3.4,
        "cohesive_energy_max_by_min": 1.361764705882353,
        "cohesive_energy_first_element": 3.4,
        "cohesive_energy_last_element": 4.63,
        "bulk_modulus_avg_weighted_norm": 75.9333554,
        "bulk_modulus_avg": 64.9,
        "bulk_modulus_max": 98.0,
        "bulk_modulus_min": 31.8,
        "bulk_modulus_max_by_min": 3.081761006289308,
        "bulk_modulus_first_element": 31.8,
        "bulk_modulus_last_element": 98.0,
    }

    diff = DeepDiff(expected_features, actual_features, significant_digits=3)
    assert diff == {}
